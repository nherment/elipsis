<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="/favicon.ico" />

    <title>Elipsis (account)</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/main.css" rel="stylesheet">
</head>

<body>

<!-- Wrap all page content here -->
<div id="wrap">

    <!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/"><img src="images/icon-white.gif"/> Elipsis</a>
            </div>
            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/vault">Vault</a></li>
                    <li><a href="/account">Account</a></li>
                    <li class="active"><a href="/subscription">Subscription</a></li>
                    <li><a href="/logout">Logout</a></li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </div>

    <!-- Begin page content -->
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <div class="page-header">
                    <h2>Subscription</h2>
                </div>


                <form id="#subscriptionForm" role="form" action="/api/subscription/subscribe" method="post">
                    <div class="form-group">
                        <label for="card-number">Card number</label>
                        <input type="text" id="card-number" size="30" autocomplete="off" class="form-control"/>
                    </div>
                    <div class="form-group">
                        <label for="card-cvc">CVC</label>
                        <input type="text" id="card-cvc" size="4" autocomplete="off" class="form-control"/>
                    </div>
                    <div class="form-group">
                        <label for="expiration-date">Expiration (MM/YYYY)</label>
                        <input id="expiration-date" type="text" name="expiration-date" autocomplete="off" size="7" class="form-control"/>
                    </div>

                    <div class="form-group">
                        <label for="plan">Your plan </label>
                        <div id="plan" class="btn-group">
                            <button type="button" class="btn btn-default">Free</button>
                            <button type="button" class="btn btn-default">Gold</button>
                            <!--<button type="button" class="btn btn-default disabled">Platinum</button>-->
                        </div>
                    </div>
                    <div id="error" class="alert alert-danger"></div>
                    <div id="success" class="alert success">Thanks for subscribing at elipsis.io!</div>
                    <img id="spinner" class="pull-right" src="/images/spinner.gif"/>
                    <button id="cancel-subscription-btn" class="btn btn-danger">Cancel subscription</button>
                    <button id="subscribe-btn" type="submit" class="btn btn-success">Subscribe</button>
                </form>


            </div>
        </div>
    </div>
</div>

<div id="footer">
    <div class="container">
        <p class="text-muted credit">Elipsis is <a href="http://github.com/nherment/elipsis/">open source</a>.</p>
    </div>
</div>


<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="/js/jquery-2.0.3.js"></script>
<script src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://js.stripe.com/v2/"></script>
<script type="application/javascript">

    function spin() {
        $('#spinner').show()
        $('#cancel-subscription-btn').hide()
        $('#subscribe-btn').hide()

        $('#success').hide()
        $('#error').hide()
    }

    function unspin() {
        $('#spinner').hide()
        $('#cancel-subscription-btn').show()
        $('#subscribe-btn').show()
    }

    function error(msg) {
        $("#error").html(msg)
        $("#error").show()
        $('#success').hide()
    }

    function success(msg) {
        $("#success").html(msg)
        $("#success").show()
        $('#error').hide()
    }

    $(document).ready(function() {

        unspin()

        $('#error').hide()
        $('#success').hide()

        Stripe.setPublishableKey('pk_bW6aPfvZFosLP6ZSOTFreMIlDLsKa');
        $('#cancel-subscription-btn').click(function() {
            spin()
            $.post('/api/subscription/cancel', {}).
                done(function() {
                    success('Subscription cancelled. You will receive a confirmation email.')
                    unspin()
                }).
                fail(function(xhr) {
                    error(xhr.responseText)
                    unspin()
                })

            return false
        })
        $('#subscribe-btn').click(function() {

            $('#error').hide()
            $('#success').hide()

            $('#expiration-date').removeClass('error')
            $('#card-number').removeClass('error')
            $('#card-cvc').removeClass('error')

            var hasError = false

            if(!Stripe.card.validateCardNumber($('#card-number').val())) {
                $('#card-number').addClass('error')
                hasError = true
            }

            if(!Stripe.card.validateCVC($('#card-cvc').val())) {
                $('#card-cvc').addClass('error')
                hasError = true
            }

            if(!/^\d{2}\/\d{4}$/m.test($('#expiration-date').val())) {
                $('#expiration-date').addClass('error')
                hasError = true
            } else {
                var expMonth = $('#expiration-date').val().substring(0,2)
                var expYear = $('#expiration-date').val().substring(3,7)
                if(!Stripe.card.validateExpiry(expMonth, expYear)) {
                    $('#expiration-date').addClass('error')
                    hasError = true
                }
            }

            if(hasError) {
                return false
            }

            spin()

            var cardInfo = {
                number: $('#card-number').val(),
                cvc: $('#card-cvc').val(),
                exp_month: expMonth,
                exp_year: expYear
            }

            Stripe.card.createToken(cardInfo, function(status, response) {
                if (response.error) {
                    error(response.error.message)
                    unspin()
                } else {
                    // token contains id, last4, and card type
                    $.post('/api/subscription/subscribe', {cardToken: response.id})
                        .done(function() {
                            $('#expiration-date').val('**/****')
                            $('#card-number').val('************'+response.last4)
                            $('#card-cvc').val('***')

                            success('Thank you for your subscription !')
                            unspin()
                        })
                        .fail(function(xhr, status, err) {
                            error(xhr.responseText)
                            unspin()
                        })
                }
            });
            return false;
        })
    })

</script>
</body>
</html>
